name: Build, Test and Deploy ðŸ’»

on:  # events that will trigger workflow
  push:
    paths-ignore:
      - '**.md' #ignore readme and presentation changes
  pull_request: 
    branches:
      - based
    paths-ignore:
      - '**.md' 

jobs:
  buildForAllSupportedPlatforms:
    name: Build, Test and Deploy for ${{ matrix.targetPlatform }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # if one build fails, other platforms will still be built
      matrix:
        targetPlatform:
          - StandaloneWindows64
          - WebGL
          - StandaloneOSX
        
    steps:
      # Fetch Files  
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          lfs: true
      
      # Cache Unity Library Folder
      - uses: actions/cache@v2
        with:
          path: Library
          key: Library-${{ matrix.targetPlatform }}
          restore-keys: Library-

      # Test playmode and editmode
      - uses: game-ci/unity-test-runner@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          # https://docs.github.com/en/actions/security-guides/automatic-token-authentication#about-the-github_token-secret
          githubToken: ${{ secrets.GITHUB_TOKEN }} # used to view test results 
      
      # Build Unity Game
      - uses: game-ci/unity-builder@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          targetPlatform: ${{ matrix.targetPlatform }}
      
      # Upload Build as Artifacts
      #- uses: actions/upload-artifact@v2
      #  with:
      #    name: Build-${{ matrix.targetPlatform }}
      #    path: build/${{ matrix.targetPlatform }}
      
      # Publish to Itch.IO
      - uses: manleydev/butler-publish-itchio-action@master
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_CREDENTIALS }}
          CHANNEL: ${{ matrix.targetPlatform }}
          ITCH_GAME: deployexample
          ITCH_USER: Macawls
          PACKAGE: build/${{ matrix.targetPlatform }}

      